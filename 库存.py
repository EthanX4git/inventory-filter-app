{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "2342f9be-fcff-43a6-8c90-3844cfdf35e6",
   "metadata": {},
   "outputs": [],
   "source": [
    "import streamlit as st\n",
    "import pandas as pd\n",
    "from openpyxl import load_workbook\n",
    "from openpyxl.styles import PatternFill\n",
    "import tempfile\n",
    "import os\n",
    "\n",
    "# Streamlit é¡µé¢é…ç½®\n",
    "st.set_page_config(page_title=\"åº“å­˜ç­›é€‰å·¥å…·\", layout=\"wide\")\n",
    "\n",
    "st.title(\"ğŸ“Š åº“å­˜ç­›é€‰è‡ªåŠ¨åŒ–å·¥å…·\")\n",
    "st.write(\"è¯·ä¸Šä¼  Excel æ–‡ä»¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨å¤„ç†ï¼Œå¹¶æä¾›ä¸‹è½½ã€‚\")\n",
    "\n",
    "# ä¸Šä¼ æ–‡ä»¶\n",
    "uploaded_file = st.file_uploader(\"ğŸ“‚ é€‰æ‹© Excel æ–‡ä»¶\", type=[\"xlsx\"])\n",
    "\n",
    "def process_inventory_data(file_path):\n",
    "    \"\"\" å¤„ç†åº“å­˜æ•°æ® \"\"\"\n",
    "    xls = pd.ExcelFile(file_path)\n",
    "    sheet_name = xls.sheet_names[0]  # å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨\n",
    "    df = pd.read_excel(file_path, sheet_name=sheet_name)\n",
    "\n",
    "    # ä½¿ç”¨ç¬¬ä¸€è¡Œä½œä¸ºåˆ—å\n",
    "    df.columns = df.iloc[0]\n",
    "    df = df[1:].reset_index(drop=True)\n",
    "\n",
    "    # è°ƒæ•´åˆ—å\n",
    "    columns = df.columns.to_list()\n",
    "    stl_count, pa_count = 0, 0\n",
    "    for i in range(len(columns)):\n",
    "        if columns[i] == \"æ˜“æ·å¿«é€’:STL-Warehouse\":\n",
    "            stl_count += 1\n",
    "            columns[i] = \"æ˜“æ·å¿«é€’:STL-Warehouse-æµ·å¤–ä»“åº“å­˜\" if stl_count == 1 else \"æ˜“æ·å¿«é€’:STL-Warehouse-æµ·å¤–ä»“åœ¨é€”åº“å­˜\"\n",
    "        if columns[i] == \"æ˜“æ·å¿«é€’:PA Warehouse\":\n",
    "            pa_count += 1\n",
    "            columns[i] = \"æ˜“æ·å¿«é€’:PA Warehouse-æµ·å¤–ä»“åº“å­˜\" if pa_count == 1 else \"æ˜“æ·å¿«é€’:PA Warehouse-æµ·å¤–ä»“åœ¨é€”åº“å­˜\"\n",
    "    df.columns = columns\n",
    "\n",
    "    # å¡«å…… NaN å€¼\n",
    "    df = df.fillna(0)\n",
    "\n",
    "    # éœ€è¦æ£€æŸ¥çš„åˆ—\n",
    "    required_columns = [\n",
    "        \"SKU\", \"FBAå¯ç”¨å¤©æ•°\", \"FBAå¯ç”¨+å…¥åº“å¤©æ•°\",\n",
    "        \"æ˜“æ·å¿«é€’:STL-Warehouse-æµ·å¤–ä»“åº“å­˜\", \"æ˜“æ·å¿«é€’:PA Warehouse-æµ·å¤–ä»“åº“å­˜\",\n",
    "        \"è¿‘7å¤©æ—¥å‡é”€é‡\", \"è¿‘2å¤©æ—¥å‡é”€é‡\"\n",
    "    ]\n",
    "    \n",
    "    # è½¬æ¢æ•°æ®ç±»å‹\n",
    "    for col in required_columns[1:]:\n",
    "        df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0)\n",
    "\n",
    "    # ç­›é€‰ç¬¦åˆæ¡ä»¶çš„ SKU ç»„\n",
    "    df_filtered = pd.DataFrame(columns=df.columns)\n",
    "    unique_skus = df[\"SKU\"].unique()\n",
    "    for sku in unique_skus:\n",
    "        sku_group = df[df[\"SKU\"] == sku]\n",
    "\n",
    "        # ç­›é€‰é€»è¾‘\n",
    "        condition1 = (sku_group[\"FBAå¯ç”¨å¤©æ•°\"] <= 20) & (sku_group[\"FBAå¯ç”¨å¤©æ•°\"] > 0)\n",
    "        condition2 = (sku_group[\"FBAå¯ç”¨+å…¥åº“å¤©æ•°\"] <= 40) & (sku_group[\"FBAå¯ç”¨+å…¥åº“å¤©æ•°\"] > 0)\n",
    "        max_warehouse_stock = sku_group[[\"æ˜“æ·å¿«é€’:STL-Warehouse-æµ·å¤–ä»“åº“å­˜\", \"æ˜“æ·å¿«é€’:PA Warehouse-æµ·å¤–ä»“åº“å­˜\"]].max(axis=1)\n",
    "        max_sales_threshold = sku_group[[\"è¿‘7å¤©æ—¥å‡é”€é‡\", \"è¿‘2å¤©æ—¥å‡é”€é‡\"]].max(axis=1) * 5\n",
    "        condition3 = max_warehouse_stock > max_sales_threshold\n",
    "\n",
    "        if any(condition1 | condition2) and any(condition3):\n",
    "            df_filtered = pd.concat([df_filtered, sku_group, pd.DataFrame([[\"\"] * len(df.columns)], columns=df.columns)], ignore_index=True)\n",
    "\n",
    "    # åˆ›å»ºä¸´æ—¶æ–‡ä»¶ä¿å­˜å¤„ç†ç»“æœ\n",
    "    temp_file = tempfile.NamedTemporaryFile(delete=False, suffix=\".xlsx\")\n",
    "    df_filtered.to_excel(temp_file.name, index=False)\n",
    "\n",
    "    # é¢œè‰²å¡«å……\n",
    "    wb = load_workbook(temp_file.name)\n",
    "    ws = wb.active\n",
    "\n",
    "    # é¢œè‰²å¡«å……æ ·å¼\n",
    "    fill_light_blue = PatternFill(start_color=\"ADD8E6\", end_color=\"ADD8E6\", fill_type=\"solid\")  # æµ…è“è‰²\n",
    "    fill_light_red = PatternFill(start_color=\"FFC0C0\", end_color=\"FFC0C0\", fill_type=\"solid\")  # æµ…çº¢è‰²\n",
    "\n",
    "    # è·å– \"ASIN\"ã€\"FBAå¯ç”¨å¤©æ•°\"ã€\"FBAå¯ç”¨+å…¥åº“å¤©æ•°\" çš„åˆ—ç´¢å¼•\n",
    "    asin_col_idx = df_filtered.columns.get_loc(\"ASIN\") + 1\n",
    "    fba_days_col_idx = df_filtered.columns.get_loc(\"FBAå¯ç”¨å¤©æ•°\") + 1\n",
    "    fba_inbound_days_col_idx = df_filtered.columns.get_loc(\"FBAå¯ç”¨+å…¥åº“å¤©æ•°\") + 1\n",
    "\n",
    "    for row_idx, row in enumerate(ws.iter_rows(min_row=2, max_row=ws.max_row), start=2):\n",
    "        # ASIN=Total å¡«å……æµ…è“è‰²\n",
    "        if row[asin_col_idx - 1].value == \"Total\":\n",
    "            for cell in ws[row_idx]:\n",
    "                cell.fill = fill_light_blue\n",
    "\n",
    "        # FBA å¯ç”¨å¤©æ•° å¡«å……æµ…çº¢è‰²\n",
    "        fba_days_cell = ws.cell(row=row_idx, column=fba_days_col_idx)\n",
    "        fba_inbound_days_cell = ws.cell(row=row_idx, column=fba_inbound_days_col_idx)\n",
    "\n",
    "        if isinstance(fba_days_cell.value, (int, float)) and 0 < fba_days_cell.value <= 20:\n",
    "            fba_days_cell.fill = fill_light_red\n",
    "        if isinstance(fba_inbound_days_cell.value, (int, float)) and 0 < fba_inbound_days_cell.value <= 40:\n",
    "            fba_inbound_days_cell.fill = fill_light_red\n",
    "\n",
    "    # ä¿å­˜ Excel\n",
    "    wb.save(temp_file.name)\n",
    "    return temp_file.name\n",
    "\n",
    "# è¿è¡Œæ•°æ®å¤„ç†\n",
    "if uploaded_file is not None:\n",
    "    st.success(\"ğŸ“Š æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨å¤„ç†æ•°æ®...\")\n",
    "    processed_file_path = process_inventory_data(uploaded_file)\n",
    "\n",
    "    # æä¾›ä¸‹è½½æŒ‰é’®\n",
    "    with open(processed_file_path, \"rb\") as file:\n",
    "        st.download_button(label=\"ğŸ“¥ ä¸‹è½½å¤„ç†åçš„ Excel æ–‡ä»¶\", data=file, file_name=\"åº“å­˜ç®¡ç†_ç­›é€‰.xlsx\", mime=\"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\")\n",
    "\n",
    "    # åˆ é™¤ä¸´æ—¶æ–‡ä»¶\n",
    "    os.remove(processed_file_path)"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python [conda env:base] *",
   "language": "python",
   "name": "conda-base-py"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.7"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
